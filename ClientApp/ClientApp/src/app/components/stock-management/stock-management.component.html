<div class="container-fluid py-4">
  <!-- Header -->
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
          <h2 class="text-dark fw-bold mb-0">Stock Management</h2>
          <p class="text-muted mb-0">Manage inventory levels and track stock movements</p>
        </div>
        <div class="d-flex gap-2">
          <button class="btn btn-outline-primary" (click)="refreshData()" [disabled]="loading">
            <i class="fas fa-sync-alt" [class.fa-spin]="loading"></i>
            Refresh
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Filters -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card border-0 shadow-sm">
        <div class="card-body">
          <div class="row g-3">
            <!-- Search -->
            <div class="col-xl-4 col-lg-6">
              <label class="form-label fw-semibold">Search Products</label>
              <div class="input-group">
                <span class="input-group-text">
                  <i class="fas fa-search"></i>
                </span>
                <input 
                  type="text" 
                  class="form-control" 
                  placeholder="Search by name, reference..."
                  [(ngModel)]="searchTerm"
                  (ngModelChange)="onSearchChange()">
              </div>
            </div>

            <!-- Stock Filter -->
            <div class="col-xl-3 col-lg-6">
              <label class="form-label fw-semibold">Stock Status</label>
              <select 
                class="form-select" 
                [(ngModel)]="stockFilter"
                (ngModelChange)="onFilterChange()">
                <option *ngFor="let option of stockFilterOptions" [value]="option.value">
                  {{ option.label }}
                </option>
              </select>
            </div>

            <!-- Page Size -->
            <div class="col-xl-2 col-lg-4">
              <label class="form-label fw-semibold">Per Page</label>
              <select 
                class="form-select" 
                [(ngModel)]="pageSize"
                (ngModelChange)="onFilterChange()">
                <option value="10">10</option>
                <option value="25">25</option>
                <option value="50">50</option>
                <option value="100">100</option>
              </select>
            </div>

            <!-- Results Count -->
            <div class="col-xl-3 col-lg-8">
              <label class="form-label fw-semibold">Results</label>
              <div class="form-control-plaintext">
                <span class="badge bg-primary">{{ formatNumber(totalItems) }}</span> products found
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading" class="row">
    <div class="col-12">
      <div class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3 text-muted">Loading products...</p>
      </div>
    </div>
  </div>

  <!-- Error State -->
  <div *ngIf="error && !loading" class="row">
    <div class="col-12">
      <div class="alert alert-danger" role="alert">
        <i class="fas fa-exclamation-triangle me-2"></i>
        {{ error }}
      </div>
    </div>
  </div>

  <!-- Products Table -->
  <div *ngIf="!loading && !error" class="row">
    <div class="col-12">
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-white border-0 py-3">
          <h5 class="card-title mb-0 fw-bold">Products Inventory</h5>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover mb-0">
              <thead class="table-light">
                <tr>
                  <th>Product</th>
                  <th>Category</th>
                  <th>Current Stock</th>
                  <th>Min/Max Stock</th>
                  <th>Status</th>
                  <th>Stock Value</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let product of products">
                  <td>
                    <div>
                      <h6 class="mb-1">{{ product.designation }}</h6>
                      <small class="text-muted">{{ product.reference }}</small>
                    </div>
                  </td>
                  <td>
                    <span class="badge bg-light text-dark">{{ product.categorie }}</span>
                  </td>
                  <td>
                    <div class="d-flex align-items-center">
                      <span class="fw-bold me-2">{{ formatNumber(product.stockActuel) }}</span>
                      <small class="text-muted">{{ product.unite }}</small>
                    </div>
                    <!-- Variants -->
                    <div *ngIf="product.variantes.length > 0" class="mt-1">
                      <small class="text-muted">
                        {{ product.variantes.length }} variant(s)
                      </small>
                    </div>
                  </td>
                  <td>
                    <div class="d-flex align-items-center gap-1">
                      <span class="badge bg-warning text-dark">{{ formatNumber(product.stockMinimum) }}</span>
                      <span class="text-muted">/</span>
                      <span class="badge bg-info">{{ formatNumber(product.stockMaximum) }}</span>
                    </div>
                  </td>
                  <td>
                    <span [ngClass]="getStockStatusBadgeClass(product)">
                      {{ getStockStatusText(product) }}
                    </span>
                  </td>
                  <td>
                    <span class="fw-bold">{{ formatCurrency(product.valeurStock) }}</span>
                  </td>
                  <td>
                    <div class="btn-group btn-group-sm" role="group">
                      <button 
                        class="btn btn-outline-primary"
                        (click)="openAdjustmentModal(product)"
                        [disabled]="!canManageStock()"
                        title="Adjust Stock">
                        <i class="fas fa-edit"></i>
                      </button>
                      <!-- Variant Actions -->
                      <div *ngIf="product.variantes.length > 0" class="btn-group" ngbDropdown role="group">
                        <button 
                          class="btn btn-outline-secondary dropdown-toggle" 
                          ngbDropdownToggle
                          [disabled]="!canManageStock()">
                          Variants
                        </button>
                        <div class="dropdown-menu" ngbDropdownMenu>
                          <button 
                            *ngFor="let variant of product.variantes"
                            class="dropdown-item"
                            (click)="openAdjustmentModal(product, variant.id)">
                            {{ variant.taille }} - {{ variant.couleur }}
                            <span class="badge bg-secondary ms-2">{{ variant.stockActuel }}</span>
                          </button>
                        </div>
                      </div>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Empty State -->
          <div *ngIf="products.length === 0" class="text-center py-5">
            <i class="fas fa-boxes text-muted mb-3" style="font-size: 3rem;"></i>
            <h5 class="text-muted">No products found</h5>
            <p class="text-muted">Try adjusting your search criteria or filters.</p>
          </div>
        </div>

        <!-- Pagination -->
        <div *ngIf="getTotalPages() > 1" class="card-footer bg-white border-0">
          <nav aria-label="Products pagination">
            <ul class="pagination justify-content-center mb-0">
              <li class="page-item" [class.disabled]="currentPage === 1">
                <button class="page-link" (click)="onPageChange(currentPage - 1)" [disabled]="currentPage === 1">
                  <i class="fas fa-chevron-left"></i>
                </button>
              </li>
              
              <li *ngFor="let page of getPageNumbers()" 
                  class="page-item" 
                  [class.active]="page === currentPage">
                <button class="page-link" (click)="onPageChange(page)">{{ page }}</button>
              </li>
              
              <li class="page-item" [class.disabled]="currentPage === getTotalPages()">
                <button class="page-link" (click)="onPageChange(currentPage + 1)" [disabled]="currentPage === getTotalPages()">
                  <i class="fas fa-chevron-right"></i>
                </button>
              </li>
            </ul>
          </nav>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Stock Adjustment Modal -->
<div class="modal fade" 
     [class.show]="showAdjustmentModal" 
     [style.display]="showAdjustmentModal ? 'block' : 'none'"
     tabindex="-1" 
     role="dialog">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-edit me-2"></i>
          Stock Adjustment - {{ selectedProduct?.designation }}
        </h5>
        <button type="button" class="btn-close" (click)="closeAdjustmentModal()"></button>
      </div>

      <form [formGroup]="adjustmentForm" (ngSubmit)="submitAdjustment()">
        <div class="modal-body">
          <!-- Success Message -->
          <div *ngIf="success" class="alert alert-success" role="alert">
            <i class="fas fa-check-circle me-2"></i>
            {{ success }}
          </div>

          <!-- Error Message -->
          <div *ngIf="error" class="alert alert-danger" role="alert">
            <i class="fas fa-exclamation-triangle me-2"></i>
            {{ error }}
          </div>

          <div class="row g-3">
            <!-- Product Info -->
            <div class="col-12">
              <div class="card bg-light">
                <div class="card-body">
                  <h6 class="card-title">Product Information</h6>
                  <div class="row">
                    <div class="col-md-6">
                      <strong>Reference:</strong> {{ selectedProduct?.reference }}
                    </div>
                    <div class="col-md-6">
                      <strong>Category:</strong> {{ selectedProduct?.categorie }}
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Current Stock -->
            <div class="col-md-6">
              <label class="form-label fw-semibold">Current Stock</label>
              <div class="input-group">
                <input type="number" class="form-control" formControlName="currentStock" readonly>
                <span class="input-group-text">{{ selectedProduct?.unite }}</span>
              </div>
            </div>

            <!-- New Quantity -->
            <div class="col-md-6">
              <label class="form-label fw-semibold">New Quantity *</label>
              <div class="input-group">
                <input 
                  type="number" 
                  class="form-control" 
                  formControlName="newQuantity"
                  [class.is-invalid]="isFieldInvalid('newQuantity')"
                  min="0">
                <span class="input-group-text">{{ selectedProduct?.unite }}</span>
              </div>
              <div *ngIf="isFieldInvalid('newQuantity')" class="invalid-feedback">
                {{ getFieldErrorMessage('newQuantity') }}
              </div>
            </div>

            <!-- Reference -->
            <div class="col-md-6">
              <label class="form-label fw-semibold">Reference *</label>
              <input 
                type="text" 
                class="form-control" 
                formControlName="reference"
                [class.is-invalid]="isFieldInvalid('reference')"
                placeholder="ADJ-123456">
              <div *ngIf="isFieldInvalid('reference')" class="invalid-feedback">
                {{ getFieldErrorMessage('reference') }}
              </div>
            </div>

            <!-- Location -->
            <div class="col-md-6">
              <label class="form-label fw-semibold">Location *</label>
              <input 
                type="text" 
                class="form-control" 
                formControlName="emplacement"
                [class.is-invalid]="isFieldInvalid('emplacement')"
                placeholder="Main Warehouse">
              <div *ngIf="isFieldInvalid('emplacement')" class="invalid-feedback">
                {{ getFieldErrorMessage('emplacement') }}
              </div>
            </div>

            <!-- Reason -->
            <div class="col-12">
              <label class="form-label fw-semibold">Reason for Adjustment *</label>
              <textarea 
                class="form-control" 
                formControlName="reason"
                [class.is-invalid]="isFieldInvalid('reason')"
                rows="3"
                placeholder="Explain the reason for this stock adjustment..."></textarea>
              <div *ngIf="isFieldInvalid('reason')" class="invalid-feedback">
                {{ getFieldErrorMessage('reason') }}
              </div>
            </div>
          </div>

          <!-- Stock Movements History -->
          <div *ngIf="stockMovements.length > 0" class="mt-4">
            <h6>Recent Stock Movements</h6>
            <div class="table-responsive">
              <table class="table table-sm">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Type</th>
                    <th>Quantity</th>
                    <th>Reference</th>
                    <th>By</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let movement of stockMovements.slice(0, 5)">
                    <td>{{ movement.dateMouvement | date:'short' }}</td>
                    <td>
                      <span [ngClass]="getMovementTypeClass(movement.type)">
                        {{ movement.type }}
                      </span>
                    </td>
                    <td>{{ movement.quantite }}</td>
                    <td>{{ movement.referenceDocument }}</td>
                    <td>{{ movement.creePar }}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="closeAdjustmentModal()">
            Cancel
          </button>
          <button 
            type="submit" 
            class="btn btn-primary"
            [disabled]="adjustmentForm.invalid || saving">
            <i class="fas fa-save me-2" [class.fa-spin]="saving"></i>
            {{ saving ? 'Adjusting...' : 'Adjust Stock' }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal Backdrop -->
<div *ngIf="showAdjustmentModal" class="modal-backdrop fade show"></div>