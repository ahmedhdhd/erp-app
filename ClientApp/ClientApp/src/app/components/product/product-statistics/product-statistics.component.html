<div class="container-fluid py-4">
  <!-- Header -->
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
          <h2 class="text-dark fw-bold mb-0">Product Statistics</h2>
          <p class="text-muted mb-0">Overview of your product inventory and performance</p>
        </div>
        <div class="d-flex gap-2">
          <button class="btn btn-outline-primary" (click)="refreshStatistics()" [disabled]="loading">
            <i class="fas fa-sync-alt" [class.fa-spin]="loading"></i>
            Refresh
          </button>
          <button class="btn btn-primary" (click)="exportStatistics()" *ngIf="canManageProducts()">
            <i class="fas fa-download me-2"></i>
            Export
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading" class="row">
    <div class="col-12">
      <div class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3 text-muted">Loading statistics...</p>
      </div>
    </div>
  </div>

  <!-- Error State -->
  <div *ngIf="error && !loading" class="row">
    <div class="col-12">
      <div class="alert alert-danger" role="alert">
        <i class="fas fa-exclamation-triangle me-2"></i>
        {{ error }}
      </div>
    </div>
  </div>

  <!-- Statistics Cards -->
  <div *ngIf="!loading && !error" class="row g-4 mb-4">
    <!-- Total Products -->
    <div class="col-xl-3 col-md-6">
      <div class="card stats-card border-0 shadow-sm h-100">
        <div class="card-body">
          <div class="d-flex align-items-center">
            <div class="stats-icon bg-primary bg-gradient text-white rounded-3 me-3">
              <i class="fas fa-boxes"></i>
            </div>
            <div>
              <h3 class="mb-0 fw-bold">{{ formatNumber(statistics.totalProducts) }}</h3>
              <p class="text-muted mb-0">Total Products</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Active Products -->
    <div class="col-xl-3 col-md-6">
      <div class="card stats-card border-0 shadow-sm h-100">
        <div class="card-body">
          <div class="d-flex align-items-center">
            <div class="stats-icon bg-success bg-gradient text-white rounded-3 me-3">
              <i class="fas fa-check-circle"></i>
            </div>
            <div>
              <h3 class="mb-0 fw-bold">{{ formatNumber(statistics.activeProducts) }}</h3>
              <p class="text-muted mb-0">Active Products</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Low Stock Alerts -->
    <div class="col-xl-3 col-md-6">
      <div class="card stats-card border-0 shadow-sm h-100">
        <div class="card-body">
          <div class="d-flex align-items-center">
            <div class="stats-icon bg-warning bg-gradient text-white rounded-3 me-3">
              <i class="fas fa-exclamation-triangle"></i>
            </div>
            <div>
              <h3 class="mb-0 fw-bold">{{ formatNumber(statistics.lowStockProducts) }}</h3>
              <p class="text-muted mb-0">Low Stock</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Out of Stock -->
    <div class="col-xl-3 col-md-6">
      <div class="card stats-card border-0 shadow-sm h-100">
        <div class="card-body">
          <div class="d-flex align-items-center">
            <div class="stats-icon bg-danger bg-gradient text-white rounded-3 me-3">
              <i class="fas fa-times-circle"></i>
            </div>
            <div>
              <h3 class="mb-0 fw-bold">{{ formatNumber(statistics.outOfStockProducts) }}</h3>
              <p class="text-muted mb-0">Out of Stock</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Secondary Stats -->
  <div *ngIf="!loading && !error" class="row g-4 mb-4">
    <!-- Total Categories -->
    <div class="col-xl-3 col-md-6">
      <div class="card stats-card border-0 shadow-sm h-100">
        <div class="card-body">
          <div class="d-flex align-items-center">
            <div class="stats-icon bg-info bg-gradient text-white rounded-3 me-3">
              <i class="fas fa-tags"></i>
            </div>
            <div>
              <h3 class="mb-0 fw-bold">{{ formatNumber(statistics.totalCategories) }}</h3>
              <p class="text-muted mb-0">Categories</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Total Stock Value -->
    <div class="col-xl-3 col-md-6">
      <div class="card stats-card border-0 shadow-sm h-100">
        <div class="card-body">
          <div class="d-flex align-items-center">
            <div class="stats-icon bg-success bg-gradient text-white rounded-3 me-3">
              <i class="fas fa-dollar-sign"></i>
            </div>
            <div>
              <h3 class="mb-0 fw-bold">{{ formatCurrency(statistics.totalStockValue) }}</h3>
              <p class="text-muted mb-0">Stock Value</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Average Price -->
    <div class="col-xl-3 col-md-6">
      <div class="card stats-card border-0 shadow-sm h-100">
        <div class="card-body">
          <div class="d-flex align-items-center">
            <div class="stats-icon bg-secondary bg-gradient text-white rounded-3 me-3">
              <i class="fas fa-calculator"></i>
            </div>
            <div>
              <h3 class="mb-0 fw-bold">{{ formatCurrency(statistics.averagePrice) }}</h3>
              <p class="text-muted mb-0">Average Price</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Average Margin -->
    <div class="col-xl-3 col-md-6">
      <div class="card stats-card border-0 shadow-sm h-100">
        <div class="card-body">
          <div class="d-flex align-items-center">
            <div class="stats-icon bg-dark bg-gradient text-white rounded-3 me-3">
              <i class="fas fa-percentage"></i>
            </div>
            <div>
              <h3 class="mb-0 fw-bold">{{ statistics.averageMargin.toFixed(1) }}%</h3>
              <p class="text-muted mb-0">Average Margin</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Charts and Tables -->
  <div *ngIf="!loading && !error" class="row g-4">
    <!-- Top Categories -->
    <div class="col-xl-6 col-lg-12">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-header bg-white border-0 py-3">
          <h5 class="card-title mb-0 fw-bold">Top Categories</h5>
        </div>
        <div class="card-body">
          <div *ngIf="statistics.topCategories.length > 0; else noCategories">
            <div *ngFor="let category of statistics.topCategories; let i = index" class="d-flex justify-content-between align-items-center mb-3">
              <div class="d-flex align-items-center">
                <div class="category-rank me-3">
                  <span class="badge bg-primary">{{ i + 1 }}</span>
                </div>
                <div>
                  <h6 class="mb-0">{{ category.nom }}</h6>
                  <small class="text-muted">{{ formatNumber(category.nombreProduits) }} products</small>
                </div>
              </div>
              <div class="text-end">
                <div class="fw-bold">{{ formatCurrency(category.valeurStock) }}</div>
                <small class="text-muted">{{ category.pourcentageTotal.toFixed(1) }}%</small>
              </div>
            </div>
          </div>
          <ng-template #noCategories>
            <div class="text-center py-4">
              <i class="fas fa-tags text-muted mb-3" style="font-size: 3rem;"></i>
              <p class="text-muted">No categories found</p>
            </div>
          </ng-template>
        </div>
      </div>
    </div>

    <!-- Low Stock Alerts -->
    <div class="col-xl-6 col-lg-12">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-header bg-white border-0 py-3">
          <h5 class="card-title mb-0 fw-bold">Low Stock Alerts</h5>
        </div>
        <div class="card-body">
          <div *ngIf="lowStockProducts.length > 0; else noLowStock" class="low-stock-list">
            <div *ngFor="let product of lowStockProducts.slice(0, 5)" class="d-flex justify-content-between align-items-center mb-3">
              <div>
                <h6 class="mb-1">{{ product.designation }}</h6>
                <small class="text-muted">{{ product.reference }}</small>
              </div>
              <div class="text-end">
                <span class="badge bg-warning">{{ product.stockActuel }} / {{ product.stockMinimum }}</span>
                <div>
                  <small [ngClass]="getStockStatusClass(product)">{{ getStockStatusText(product) }}</small>
                </div>
              </div>
            </div>
            <div *ngIf="lowStockProducts.length > 5" class="text-center mt-3">
              <button class="btn btn-link btn-sm" routerLink="/products" [queryParams]="{filter: 'low-stock'}">
                View all {{ lowStockProducts.length }} low stock products
              </button>
            </div>
          </div>
          <ng-template #noLowStock>
            <div class="text-center py-4">
              <i class="fas fa-check-circle text-success mb-3" style="font-size: 3rem;"></i>
              <p class="text-muted">All products have adequate stock levels</p>
            </div>
          </ng-template>
        </div>
      </div>
    </div>

    <!-- Out of Stock Products -->
    <div class="col-xl-6 col-lg-12" *ngIf="outOfStockProducts.length > 0">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-header bg-white border-0 py-3">
          <h5 class="card-title mb-0 fw-bold">Out of Stock</h5>
        </div>
        <div class="card-body">
          <div class="out-of-stock-list">
            <div *ngFor="let product of outOfStockProducts.slice(0, 5)" class="d-flex justify-content-between align-items-center mb-3">
              <div>
                <h6 class="mb-1">{{ product.designation }}</h6>
                <small class="text-muted">{{ product.reference }}</small>
              </div>
              <div class="text-end">
                <span class="badge bg-danger">{{ product.stockActuel }}</span>
                <div>
                  <small class="text-danger">Out of Stock</small>
                </div>
              </div>
            </div>
            <div *ngIf="outOfStockProducts.length > 5" class="text-center mt-3">
              <button class="btn btn-link btn-sm" routerLink="/products" [queryParams]="{filter: 'out-of-stock'}">
                View all {{ outOfStockProducts.length }} out of stock products
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Recent Products -->
    <div class="col-xl-6 col-lg-12">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-header bg-white border-0 py-3">
          <h5 class="card-title mb-0 fw-bold">Recent Products</h5>
        </div>
        <div class="card-body">
          <div *ngIf="recentProducts.length > 0; else noRecentProducts">
            <div *ngFor="let product of recentProducts" class="d-flex justify-content-between align-items-center mb-3">
              <div>
                <h6 class="mb-1">{{ product.designation }}</h6>
                <small class="text-muted">{{ product.reference }} â€¢ {{ product.categorie }}</small>
              </div>
              <div class="text-end">
                <div class="fw-bold">{{ formatCurrency(product.prixVente) }}</div>
                <small class="text-muted">{{ product.dateCreation | date:'short' }}</small>
              </div>
            </div>
            <div class="text-center mt-3">
              <button class="btn btn-link btn-sm" routerLink="/products">
                View all products
              </button>
            </div>
          </div>
          <ng-template #noRecentProducts>
            <div class="text-center py-4">
              <i class="fas fa-boxes text-muted mb-3" style="font-size: 3rem;"></i>
              <p class="text-muted">No recent products found</p>
            </div>
          </ng-template>
        </div>
      </div>
    </div>
  </div>
</div>