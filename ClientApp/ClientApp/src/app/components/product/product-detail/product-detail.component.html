<div class="container-fluid">
  <!-- Page Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2 class="mb-1">{{ product?.designation || 'Product Details' }}</h2>
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item">
            <a routerLink="/dashboard" class="text-decoration-none">Dashboard</a>
          </li>
          <li class="breadcrumb-item">
            <a routerLink="/products" class="text-decoration-none">Products</a>
          </li>
          <li class="breadcrumb-item active">Details</li>
        </ol>
      </nav>
    </div>
    <div class="action-buttons">
      <button type="button" class="btn btn-outline-secondary me-2" (click)="goBack()">
        <i class="fas fa-arrow-left me-2"></i>Back to List
      </button>
      <button type="button" class="btn btn-outline-primary me-2" (click)="onPrint()" *ngIf="product">
        <i class="fas fa-print me-2"></i>Print
      </button>
      <button 
        *ngIf="hasPermission('Admin,RH,Inventaire') && product" 
        type="button" 
        class="btn btn-primary me-2" 
        (click)="editProduct()">
        <i class="fas fa-edit me-2"></i>Edit
      </button>
      <button 
        *ngIf="hasPermission('Admin') && product" 
        type="button" 
        class="btn btn-outline-danger" 
        (click)="deleteProduct()">
        <i class="fas fa-trash me-2"></i>Delete
      </button>
    </div>
  </div>

  <!-- Loading Spinner -->
  <div *ngIf="loading" class="text-center py-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-2 text-muted">Loading product details...</p>
  </div>

  <!-- Error Message -->
  <div *ngIf="errorMessage" class="alert alert-danger alert-dismissible fade show" role="alert">
    <i class="fas fa-exclamation-triangle me-2"></i>{{ errorMessage }}
    <button type="button" class="btn-close" (click)="clearError()"></button>
  </div>

  <!-- Product Details -->
  <div *ngIf="!loading && product" class="row">
    <!-- Main Information Card -->
    <div class="col-lg-8">
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-primary text-white">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
              <i class="fas fa-boxes me-2"></i>
              {{ product.designation }}
            </h5>
            <div class="status-container">
              <span 
                class="badge status-badge" 
                [ngClass]="getStatusBadgeClass(product.statut)">
                {{ product.statut }}
              </span>
              <!-- Stock Alert Badges -->
              <span *ngIf="product.estStockFaible && !product.estRuptureStock" class="badge bg-warning text-dark ms-2">
                <i class="fas fa-exclamation-triangle me-1"></i>Low Stock
              </span>
              <span *ngIf="product.estRuptureStock" class="badge bg-danger ms-2">
                <i class="bi bi-exclamation-circle me-1"></i>Out of Stock
              </span>
            </div>
          </div>
        </div>
        <div class="card-body">
          <!-- General Information Section -->
          <div class="info-section">
            <h6 class="section-title">
              <i class="bi bi-info-circle me-2"></i>General Information
            </h6>
            <div class="row">
              <div class="col-md-6">
                <div class="info-item">
                  <label>Reference:</label>
                  <span>{{ product.reference }}</span>
                </div>
                <div class="info-item">
                  <label>Designation:</label>
                  <span>{{ product.designation }}</span>
                </div>
                <div class="info-item">
                  <label>Description:</label>
                  <span>{{ product.description || 'Not specified' }}</span>
                </div>
              </div>
              <div class="col-md-6">
                <div class="info-item">
                  <label>Category:</label>
                  <span class="badge bg-secondary">{{ product.categorie }}</span>
                </div>
                <div class="info-item">
                  <label>Sub-category:</label>
                  <span>{{ product.sousCategorie || 'Not specified' }}</span>
                </div>
                <div class="info-item">
                  <label>Unit:</label>
                  <span>{{ product.unite }}</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Pricing Information Section -->
          <div class="info-section">
            <h6 class="section-title">
              <i class="bi bi-currency-euro me-2"></i>Pricing Information
            </h6>
            <div class="row">
              <div class="col-md-6">
                <div class="info-item">
                  <label>VAT Rate:</label>
                  <span>{{ product.tauxTVA }}%</span>
                </div>
                <div class="info-item">
                  <label>Purchase Price HT:</label>
                  <span>{{ formatCurrency(product.prixAchatHT) }}</span>
                </div>
                <div class="info-item">
                  <label>Purchase Price TTC:</label>
                  <span>{{ formatCurrency(product.prixAchatTTC) }}</span>
                </div>
              </div>
              <div class="col-md-6">
                <div class="info-item">
                  <label>Sale Price HT:</label>
                  <span>{{ formatCurrency(product.prixVenteHT) }}</span>
                </div>
                <div class="info-item">
                  <label>Sale Price TTC:</label>
                  <span>{{ formatCurrency(product.prixVenteTTC) }}</span>
                </div>
                <div class="info-item">
                  <label>Minimum Price HT:</label>
                  <span>{{ formatCurrency(product.prixVenteMinHT) }}</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Margin Information Section -->
          <div class="info-section">
            <h6 class="section-title">
              <i class="bi bi-graph-up me-2"></i>Margin Information
            </h6>
            <div class="row">
              <div class="col-md-4">
                <div class="salary-card">
                  <div class="salary-label">Gross Margin</div>
                  <div class="salary-value">{{ formatCurrency(product.margeBrute) }}</div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="salary-card">
                  <div class="salary-label">Margin %</div>
                  <div class="salary-value">{{ product.pourcentageMarge | number:'1.2-2' }}%</div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="salary-card total-salary">
                  <div class="salary-label">Stock Value</div>
                  <div class="salary-value">{{ formatCurrency(product.valeurStock) }}</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Stock Information Section -->
          <div class="info-section">
            <h6 class="section-title">
              <i class="bi bi-archive me-2"></i>Stock Information
            </h6>
            <div class="row">
              <div class="col-md-6">
                <div class="info-item">
                  <label>Current Stock:</label>
                  <span [class]="product.estRuptureStock ? 'text-danger' : product.estStockFaible ? 'text-warning' : 'text-success'">
                    {{ product.stockActuel }} {{ product.unite }}
                  </span>
                </div>
                <div class="info-item">
                  <label>Minimum Stock:</label>
                  <span>{{ product.stockMinimum }} {{ product.unite }}</span>
                </div>
              </div>
              <div class="col-md-6">
                <div class="info-item">
                  <label>Maximum Stock:</label>
                  <span>{{ product.stockMaximum }} {{ product.unite }}</span>
                </div>
                <div class="info-item">
                  <label>Stock Status:</label>
                  <span [class]="getStatusBadgeClass(product.statut)">
                    {{ product.statut }}
                  </span>
                </div>
              </div>
            </div>
          </div>

          <!-- Variants Section -->
          <div class="info-section" *ngIf="product.variantes && product.variantes.length > 0">
            <h6 class="section-title">
              <i class="bi bi-grid me-2"></i>Variants
            </h6>
            <div class="table-responsive">
              <table class="table table-striped table-hover">
                <thead>
                  <tr>
                    <th>Reference</th>
                    <th>Size</th>
                    <th>Color</th>
                    <th>Stock</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let variant of product.variantes">
                    <td>{{ variant.referenceVariant }}</td>
                    <td>{{ variant.taille || '-' }}</td>
                    <td>{{ variant.couleur || '-' }}</td>
                    <td>
                      <span [class]="variant.estRuptureStock ? 'text-danger' : 'text-success'">
                        {{ variant.stockActuel }}
                      </span>
                    </td>
                    <td>
                      <span [class]="variant.estRuptureStock ? 'badge bg-danger' : 'badge bg-success'">
                        {{ variant.estRuptureStock ? 'Out of Stock' : 'In Stock' }}
                      </span>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Stock Movements Section -->
          <div class="info-section">
            <h6 class="section-title">
              <i class="bi bi-arrow-left-right me-2"></i>Recent Stock Movements
            </h6>
            <div class="table-responsive" *ngIf="stockMovements.length > 0; else noMovements">
              <table class="table table-striped table-hover">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Type</th>
                    <th>Quantity</th>
                    <th>Reference</th>
                    <th>Location</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let movement of stockMovements">
                    <td>{{ formatDate(movement.dateMouvement) }}</td>
                    <td>{{ movement.type }}</td>
                    <td>{{ movement.quantite }}</td>
                    <td>{{ movement.referenceDocument }}</td>
                    <td>{{ movement.emplacement || '-' }}</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <ng-template #noMovements>
              <p class="text-muted">No stock movements recorded for this product.</p>
            </ng-template>
          </div>

          <!-- System Information Section -->
          <div class="info-section">
            <h6 class="section-title">
              <i class="bi bi-info-circle me-2"></i>System Information
            </h6>
            <div class="row">
              <div class="col-md-6">
                <div class="info-item">
                  <label>Created:</label>
                  <span>{{ formatDate(product.dateCreation) }}</span>
                </div>
              </div>
              <div class="col-md-6">
                <div class="info-item">
                  <label>Last Modified:</label>
                  <span>{{ product.dateModification ? formatDate(product.dateModification) : 'N/A' }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Quick Actions Sidebar -->
    <div class="col-lg-4">
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-light">
          <h6 class="mb-0">
            <i class="bi bi-lightning me-2"></i>Quick Actions
          </h6>
        </div>
        <div class="card-body">
          <div class="quick-action-item">
            <button 
              *ngIf="hasPermission('Admin,RH,Inventaire')" 
              class="btn btn-outline-primary w-100 mb-2" 
              (click)="editProduct()">
              <i class="bi bi-pencil me-2"></i>Edit Product
            </button>
          </div>
          <div class="quick-action-item">
            <button 
              class="btn btn-outline-info w-100 mb-2" 
              (click)="onPrint()">
              <i class="bi bi-printer me-2"></i>Print Details
            </button>
          </div>
          <div class="quick-action-item">
            <button 
              *ngIf="hasPermission('Admin')" 
              class="btn btn-outline-danger w-100" 
              (click)="deleteProduct()">
              <i class="bi bi-trash me-2"></i>Delete Product
            </button>
          </div>
        </div>
      </div>

      <!-- Product Stats Card -->
      <div class="card shadow-sm">
        <div class="card-header bg-light">
          <h6 class="mb-0">
            <i class="bi bi-bar-chart me-2"></i>Product Stats
          </h6>
        </div>
        <div class="card-body">
          <div class="stat-item">
            <div class="stat-label">Product ID</div>
            <div class="stat-value">#{{ product.id }}</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">Current Stock</div>
            <div class="stat-value">{{ product.stockActuel }} {{ product.unite }}</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">Stock Value</div>
            <div class="stat-value text-success">{{ formatCurrency(product.valeurStock) }}</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">Sale Price TTC</div>
            <div class="stat-value text-primary">{{ formatCurrency(product.prixVenteTTC) }}</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- No Data Message -->
  <div *ngIf="!loading && !product" class="text-center py-5">
    <i class="bi bi-box-seam text-muted" style="font-size: 4rem;"></i>
    <h4 class="text-muted mt-3">Product Not Found</h4>
    <p class="text-muted">The requested product could not be found.</p>
    <button type="button" class="btn btn-primary" (click)="goBack()">
      <i class="bi bi-arrow-left me-2"></i>Back to Product List
    </button>
  </div>
</div>

<ng-template #loadingTemplate>
  <div class="d-flex justify-content-center align-items-center" style="height: 200px;">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>
</ng-template>